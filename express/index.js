const express = require('express');
const app = express();
const dotenv = require('dotenv');
dotenv.config();
const jwt = require('jsonwebtoken');
const bcrypt = require('bcrypt');
const cors = require('cors');
const port = process.env.PORT || 5000;

const { pool, checkConnection } = require('./db');

// Middleware
app.use(cors({
  origin: 'http://localhost:3000', // URL Ð²Ð°ÑˆÐµÐ³Ð¾ React Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
  credentials: true
}));
app.use(express.json());

// Middleware Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
const authenticateToken = async (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ error: 'Ð¢Ð¾ÐºÐµÐ½ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚' });
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    const [users] = await pool.execute(
      'SELECT user_id, name, surname, nick, email, role, is_active, avatar_url, is_online FROM users WHERE user_id = ?',
      [decoded.userId]
    );

    if (users.length === 0 || !users[0].is_active) {
      return res.status(403).json({ error: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð»Ð¸ Ð½ÐµÐ°ÐºÑ‚Ð¸Ð²ÐµÐ½' });
    }

    req.user = users[0];
    next();
  } catch (error) {
    return res.status(403).json({ error: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½' });
  }
};

// Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ€Ð¾ÑƒÑ‚Ñ‹
const authRoutes = require('./routes/authRoutes');
const userRoutes = require('./routes/userRoutes');

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ñ€Ð¾ÑƒÑ‚Ñ‹
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);

// Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚
app.get('/', (req, res) => {
  res.json({ message: 'ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð½Ð¾!' });
});

// Health check
app.get('/health', async (req, res) => {
  try {
    const dbConnected = await checkConnection();
    res.json({ 
      status: 'OK', 
      database: dbConnected ? 'Connected' : 'Disconnected',
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    res.status(500).json({ status: 'Error', error: error.message });
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° 404
app.use((req, res) => {
  res.status(404).json({ 
    error: 'ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½',
    path: req.originalUrl,
    method: req.method
  });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
app.use((error, req, res, next) => {
  console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°:', error);
  res.status(500).json({ error: 'Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
app.listen(port, async () => {
  console.log('ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ: ' + port);
  await checkConnection();
});

module.exports = app;